# balena-google-assistant
## Introduction
Runs the google assistant (_"OK Google"_) on a raspberry pi.

In other words it turns your raspberry pi into a "_google home_" device

## Hardware requirements

1. speaker (or headphone) that is connected to the audio jack of the raspberry pi
2. USB microphone (or webcam with microphone) that is connected to one of the USB ports of the raspberry pi.

## STEP 1: Configure Google Project and Register Device Model
This repository is based on the instructions specified at: https://developers.google.com/assistant/sdk/guides/library/python/

So first you need to perform the following steps of these instructions:

1. [Configure a Developer Project and Account Settings](https://developers.google.com/assistant/sdk/guides/library/python/embed/config-dev-project-and-account).  Write down the _Project ID_ generated by google as you need it in STEP 2.
2. [Register the Device Model](https://developers.google.com/assistant/sdk/guides/library/python/embed/register-device) - you don't need to transfer the downloaded client secret to the raspberry pi.  You will need it for setting the service variable "GOOGLE_ASSISTANT_CLIENT_SECRET" in the next step.  Also write down the _device model ID_ generated by google as you will also need this in next step.

## STEP 2: deploy this balena application.

1. Follow the standard instructions to create and deploy a balena application  = amongst others:  (fork and) clone this github repository, create the git remote for this balena application and then do a `git push balena master` (or similar command) 
2. As you have not set any service variables you will see errors in the log files.
3. Set the following service variables using the balena dashboard.

| Service            | Name  |  Description                                    |
|------------------------- | -------------- |-------------------------------------------------|
| **google_assistant**  |    **GOOGLE_ASSISTANT_PROJECT_ID**       |  The _project ID_ generated by google in previous step. Don't confuse this with the project name that you have specified. |
| **google_assistant**  |    **GOOGLE_ASSISTANT_DEVICE_MODEL_ID**  |  The _device model id_ generated by google in previous step |
| **google_assistant**  |    **GOOGLE_ASSISTANT_CLIENT_SECRET**  |  The complete _client secret_ (= json string) retrieved in previous step |

4. When the GOOGLE_ASSISTANT service is restarted you should see something like the following in the balena Logs (this also means that you can continue with the next step):
```
17.06.19 08:46:12 (+0200) Starting service 'google_assistant sha256:2c90a535e07e0d1820a8706f0ff40aec8dcf7f29686684287b01afa637a97944'
17.06.19 08:46:13 (+0200)  google_assistant  Device Service Variable 'GOOGLE_ASSISTANT_CREDENTIALS' is not set !
17.06.19 08:46:13 (+0200)  google_assistant  Creating /client_secret.json based on the contents of device service variables GOOGLE_ASSISTANT_CLIENT_SECRET...
17.06.19 08:46:13 (+0200)  google_assistant  You can now create the google credentials by launching the script /create_credentials.sh in a balena terminal for the service 'google_assistant'.
17.06.19 08:46:13 (+0200) Started service 'google_assistant sha256:2c90a535e07e0d1820a8706f0ff40aec8dcf7f29686684287b01afa637a97944'
```

## STEP 3: Create the (google assistant) credentials
1. In Balena dashboard open a Terminal for the service "GOOGLE_ASSISTANT" and enter the command `/create_credentials.sh`
You should see something like (I partially masked it):
```
root@f0bc010:/# /create_credentials.sh
Please visit this URL to authorize this application: https://accounts.google.com/o/oauth2/auth?response_type=code&client_id=3983XXXXXXX84fb.apps.googleusercontent.com&redirect_uri=urn%3AietXXXXXXXh%3A2.0%3Aoob&scope=https%3A%2XXXXXXXapis.com%2Fauth%2Fassistant-sdk-prototype+https%3A%2F%2Fwww.googleapis.com%2Fauth%2Fgcm&state=d720mXXXXXXXXXXXXXXXXXXXXXXXXXX&code_challenge=GXXXXXXXJs&code_challenge_method=SXXXXXXX6&prompt=consent&access_type=offline
Enter the authorization code:
```
2. Copy paste above URL in a browser and follow the instructions as outlined in step 3. of [Generate Credentials](https://developers.google.com/assistant/sdk/guides/library/python/embed/install-sample).
3. copy paste the authorization code in the balena terminal window and you should get something like:
```
credentials saved: /path/to/.config/google-oauthlib-tool/credentials.json
```
4. copy the complete contents of this credentials.json (you can do that by opening the file with the  `nano`  text editorcommand).
5. create a new service variable GOOGLE_ASSISTANT_CREDENTIALS:

| Service            | Name  |  Description                                    |
|------------------------- | -------------- |-------------------------------------------------|
| **google_assistant**  |    **GOOGLE_ASSISTANT_CREDENTIALS**       |  The complete credentials (= json string) retrieved in previous step |
6. previous step will automatically restart the *GOOGLE_ASSISTANT* service and if everything goes fine you should see something like below indicating that your google assistent is up and running.
```
17.06.19 00:25:25 (+0200) Starting service 'google_assistant sha256:47e2a96dfd306851d3c4934cdf05eae46ab5d21b89c14303b44d37d5fd1c99a1'
17.06.19 00:25:26 (+0200)  google_assistant  Creating the /root/.config/google-oauthlib-tool/credentials.json using device service variable GOOGLE_ASSISTANT_CREDENTIALS ...
17.06.19 00:25:26 (+0200)  google_assistant  Starting googlesamples-assistant-hotword ...
17.06.19 00:25:26 (+0200) Started service 'google_assistant sha256:47e2a96dfd306851d3c4934cdf05eae46ab5d21b89c14303b44d37d5fd1c99a1'
17.06.19 00:25:31 (+0200)  google_assistant  device_model_id: pi3thrXXXXXXXXXXXXX44
17.06.19 00:25:31 (+0200)  google_assistant  device_id: B12XXXXXXXXXXXXX64E3
17.06.19 00:25:31 (+0200)  google_assistant  
17.06.19 00:25:36 (+0200)  google_assistant  Registering...Done.
17.06.19 00:25:36 (+0200)  google_assistant  
17.06.19 00:25:36 (+0200)  google_assistant  ON_MUTED_CHANGED:
17.06.19 00:25:36 (+0200)  google_assistant   {"is_muted": false}
17.06.19 00:25:36 (+0200)  google_assistant  ON_START_FINISHED
17.06.19 00:25:36 (+0200)  google_assistant  ON_MEDIA_STATE_IDLE
```

# Troubleshooting
## ERROR "`google_assistant  [FATAL:audio_input_stream.cc(47)] Input device could not be opened: default`"
This indicates that the default audio input stream (= microphone) is not properly configured on your raspberry pi.

# Miscellaneous

## Testing the audio

You can test the speakers (audio) by running the command:
`speaker-test -c2 -t wav`

You can change the volume by running the command `alsamixer`
